<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Room</title>
        <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
        <style>
            #house {
                display: block;
                border: 1px solid black;
                margin: 0 auto;
                width: 80%;
                height: 500px;
            }

            #box {
                display: block;
                border: 1px solid black;
                position: absolute;
            }

            #fan {
                display: block;
                width: 100px;
                height: 100px;
                margin: 20px auto;
            }

            #light {
                width: 250px;
                height: 450px;
            }

            .speed1 {
                animation: rotation 1s infinite linear;
            }

            .speed2 {
                animation: rotation 0.7s infinite linear;
            }

            .speed3 {
                animation: rotation 0.5s infinite linear;
            }

            .speed4 {
                animation: rotation 0.3s infinite linear;
            }

            .speed5 {
                animation: rotation 0.1s infinite linear;
            }

            .light0 {
                background-color: #5C5905;
            }

            .light1 {
                background-color: #7A7606;
            }

            .light2 {
                background-color: #A6A008;
            }

            .light3 {
                background-color: #BAB309;
            }

            .light4 {
                background-color: #DED60B;
            }

            .light5 {
                background-color: #FFF60D;
            }

            @keyframes rotation {
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>

    <body>
        <div id="house">
            <div id="box">
                <div id="light-level"></div>
                <div id="lightAuto">(L Auto)</div>
                <div id="fan-level"></div>
                <div id="fanAuto">(F Auto)</div>
            </div>
            <img src="img/fan.svg" id="fan">
            <img src="img/light.svg" id="light">
        </div>

        <script>
            // Initialize Firebase
            firebase.initializeApp({
                apiKey: "AIzaSyAm8x8KB3OBKHlt626D2GnbxiE-gkZMpUI",
                authDomain: "iotass-767a5.firebaseapp.com",
                databaseURL: "https://iotass-767a5.firebaseio.com",
                projectId: "iotass-767a5",
                storageBucket: "iotass-767a5.appspot.com",
                messagingSenderId: "968098298405",
                appId: "1:968098298405:web:23b77be48affa2208e1dcc",
                measurementId: "G-SMPQ3V0BCS"
            });

            let database = firebase.database();

            let light = database.ref("/Room/light");
            let fan = database.ref("/Room/fan");
            let lightAuto = database.ref("/Room/lightAuto");
            let fanAuto = database.ref("/Room/fanAuto");
            let temp = database.ref("/Room/temp");
            let hum = database.ref("/Room/hum");
            let intensity = database.ref("/Room/lightIntensity");
            let autoFanValue = false;
            let autoLightValue = false;

            light.on('value', function (intensity) {
                let light_level = 0;

                switch (intensity.val()) {    // light level based on incoming light intensity
                    case "0": light_level = 0; break;
                    case "51": light_level = 1; break;
                    case "102": light_level = 2; break;
                    case "153": light_level = 3; break;
                    case "204": light_level = 4; break;
                    case "255": light_level = 5; break;
                }

                $('#house').removeClass().addClass('light' + light_level);  // adjust light level
                $('#light-level').text("Light: " + light_level);  // display light level
            });

            lightAuto.on('value', function (snapshot) {
                if (snapshot.val() == "1") {
                    autoLightValue = true;
                    $('#fanAuto').show();
                    listenIntensity();
                } else {
                    autoLightValue = false;
                    $('#fanAuto').hide();
                }
            });

            fan.on('value', function (fan_speed) {
                $('#fan').removeClass();

                if (fan_speed.val() >= 1 && fan_speed.val() <= 5) $('#fan').addClass("speed" + fan_speed.val());

                $('#fan-level').text("Fan: " + fan_speed.val());
            });

            fanAuto.on('value', function (snapshot) {
                if (snapshot.val() == "1") {
                    autoFanValue = true
                    $('#fanAuto').show()
                    listenTemp();
                }
                else {
                    autoFanValue = false
                    $('#fanAuto').hide()
                }
            });

            function autoFan(p) {
                if (p < 24) return 0;
                else if (p < 27) return 1;
                else if (p < 30) return 2;
                else if (p < 33) return 3;
                else if (p < 36) return 4;
                else return 5;
            }

            function autoLight(q) {
                var p = parseInt(q, 10)
                if (p > 400) return 0;
                else if (p > 300) return 51;
                else if (p > 200) return 102;
                else if (p > 100) return 153;
                else if (p > 50) return 204;
                else return 255;

            }

            function listenTemp() {
                temp.on('value', function (snapshot) {
                    if (autoFanValue) {
                        var q = autoFan(snapshot.val())
                        fan.set(q.toString())
                    }
                });
            }

            function listenIntensity() {
                intensity.on('value', function (snapshot) {
                    if (autoLightValue) {
                        var q = autoLight(snapshot.val())
                        light.set(q.toString())
                    }
                });
            }

        </script>
    </body>

</html>